

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Playing an instrument &mdash; Extempore 0.7.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Extempore 0.7.0 documentation" href="index.html"/>
        <link rel="next" title="“Common Lisp Music”-style example" href="common-lisp-music.html"/>
        <link rel="prev" title="Making an instrument" href="making-an-instrument.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Extempore
          

          
          </a>

          
            
            
              <div class="version">
                0.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing Extempore</a></li>
<li class="toctree-l1"><a class="reference internal" href="editor-support.html">Text editors</a></li>
<li class="toctree-l1"><a class="reference internal" href="about-this-documentation.html">About this documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Key concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="philosophy.html">The Extempore philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="caas.html">Interacting with the Extempore Compiler</a></li>
<li class="toctree-l1"><a class="reference internal" href="time.html">Time in Extempore</a></li>
<li class="toctree-l1"><a class="reference internal" href="c-xtlang-interop.html">C-xtlang interop</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheme-xtlang-interop.html">Scheme-xtlang interop</a></li>
<li class="toctree-l1"><a class="reference internal" href="concurrency.html">Concurrency</a></li>
<li class="toctree-l1"><a class="reference internal" href="memory.html">Memory management in Extempore</a></li>
</ul>
<p class="caption"><span class="caption-text">xtlang</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="types.html">xtlang types</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html#primitive-types">Primitive types</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html#aggregate-types">Aggregate types</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html#named-types">Named types</a></li>
<li class="toctree-l1"><a class="reference internal" href="types.html#generics">Generics</a></li>
<li class="toctree-l1"><a class="reference internal" href="type-inference.html">Type inferencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="best-practices.html">Best practices</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials &amp; Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="audio-signal-processing.html">Audio signal processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="making-an-instrument.html">Making an instrument</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Playing an instrument</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-an-instrument">Setting up an instrument</a></li>
<li class="toctree-l2"><a class="reference internal" href="#playing-in-time">Playing in time</a></li>
<li class="toctree-l2"><a class="reference internal" href="#playing-scales-and-chords">Playing scales and chords</a></li>
<li class="toctree-l2"><a class="reference internal" href="#temporal-recursion">Temporal recursion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pitch-classes">Pitch classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#making-chords-with-pitch-classes">Making chords with pitch classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#harmony">Harmony</a></li>
<li class="toctree-l2"><a class="reference internal" href="#beat-tempo">Beat &amp; tempo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#putting-it-all-together">Putting it all together</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="common-lisp-music.html">&#8220;Common Lisp Music&#8221;-style example</a></li>
<li class="toctree-l1"><a class="reference internal" href="sampler.html">Loading and using a sampler</a></li>
<li class="toctree-l1"><a class="reference internal" href="graphics.html">Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="impromptu-users.html">Extempore for Impromptu users</a></li>
</ul>
<p class="caption"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting-help.html">Getting Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Unit testing in Extempore</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Extempore</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Playing an instrument</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/note-level-music.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="playing-an-instrument">
<h1>Playing an instrument<a class="headerlink" href="#playing-an-instrument" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This was once a blog post&#8212;corrections/improvements
welcome.</p>
</div>
<p>Extempore (like <a class="reference external" href="http://impromptu.moso.com.au">Impromptu</a> before it) supports playing &#8216;instruments&#8217;
at a note-level. This guide covers the basics of how to play instruments
in Extempore. If you&#8217;re satisfied with just playing Extempore&#8217;s built-in
instruments (which can be found in <code class="docutils literal"><span class="pre">libs/core/instruments.xtm</span></code>) then
you can just start at this guide. The note-level approach to music
generation will be very familiar to Impromptu users.</p>
<p>If you want a deeper understanding of what&#8217;s going on &#8216;under the
hood&#8217;, see <a class="reference internal" href="making-an-instrument.html"><span class="doc">Making an instrument</span></a>, although it&#8217;s not necessary to
understand any of that to make music in Extempore.</p>
<div class="section" id="setting-up-an-instrument">
<h2>Setting up an instrument<a class="headerlink" href="#setting-up-an-instrument" title="Permalink to this headline">¶</a></h2>
<p>This is about the simplest program you can write in Extempore. It loads
an instrument and plays a single note.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; load the instruments file</span>
<span class="p">(</span><span class="nv">sys:load</span> <span class="s">&quot;libs/core/instruments.xtm&quot;</span><span class="p">)</span>

<span class="c1">;; define a synth using the provided components</span>
<span class="c1">;; synth_note_c and synth_fx</span>
<span class="p">(</span><span class="nv">bind-instrument</span> <span class="nv">synth</span> <span class="nv">synth_note_c</span> <span class="nv">synth_fx</span><span class="p">)</span>

<span class="c1">;; add the instrument to the DSP output sink closure</span>
<span class="p">(</span><span class="k">bind-func</span> <span class="nf">dsp</span><span class="kt">:DSP</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">synth</span> <span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">dsp:set!</span> <span class="nv">dsp</span><span class="p">)</span>

<span class="c1">;; play a note on our synth</span>
<span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">random</span> <span class="mi">60</span> <span class="mi">80</span><span class="p">)</span> <span class="mi">80</span> <span class="p">(</span><span class="nf">*</span> <span class="mf">1.0</span> <span class="nv">*second*</span><span class="p">))</span>
</pre></div>
</div>
<p>To run this simple program copy the code into your editor and evaluate
it&#8212;either one line at a time or all at once. When you eval the final
line (the call to <code class="docutils literal"><span class="pre">play-note</span></code>) you should hear a single note play
for one second. You can re-evaluate that line as many times as you
like&#8212;you should hear a sound each time. Notice that <code class="docutils literal"><span class="pre">random</span></code> chooses
a different pitch each time you evaluate.</p>
<p><strong>Extra credit:</strong> if you made a <code class="docutils literal"><span class="pre">saw_synth</span></code> in the <a class="reference internal" href="audio-signal-processing.html#saw-synth-doc"><span class="std std-ref">signal
processing guide</span></a>, then see if you can change the
code above to play notes on your <code class="docutils literal"><span class="pre">saw_synth</span></code> instead!</p>
<p>Notice that Extempore is responsive, in fact you should be able to
evaluate <code class="docutils literal"><span class="pre">play-note</span></code> in time with a song playing on the radio.
Extempore is a &#8216;live performance instrument&#8217; so it is designed to be
responsive. This is what I mean by interactive&#8212;we can evaluate code and
view/hear results straight away.</p>
<p>We can also create Scheme functions to trigger more complex musical
structures. Evaluate the following expression to define a function
<code class="docutils literal"><span class="pre">chord</span></code> that, when called, will play a chord on the <code class="docutils literal"><span class="pre">synth</span></code>
instrument.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="k">define</span> <span class="nv">chord</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
      <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">synth</span> <span class="mi">60</span> <span class="mi">80</span> <span class="nv">*second*</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">synth</span> <span class="mi">64</span> <span class="mi">80</span> <span class="nv">*second*</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">synth</span> <span class="mi">67</span> <span class="mi">80</span> <span class="nv">*second*</span><span class="p">)))</span>
</pre></div>
</div>
<p>Once <code class="docutils literal"><span class="pre">chord</span></code> is defined you can then call it as many times as you like
by evaluating the following expression:</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="nv">chord</span><span class="p">)</span>
</pre></div>
</div>
<p>Congratulations, you have successfully written a Scheme function to play
a C major chord. Try changing the pitch arguments to make different
chords.</p>
</div>
<div class="section" id="playing-in-time">
<h2>Playing in time<a class="headerlink" href="#playing-in-time" title="Permalink to this headline">¶</a></h2>
<p>In keeping with traditions laid down in ages past by folks much smarter
than me, I should also provide a &#8220;Hello World&#8221; example. Because we&#8217;re in
Extempore, though, let&#8217;s add a bit of a twist: we&#8217;ll <em>listen</em> to the
string &#8220;Hello World&#8221; instead of printing it to the log.</p>
<p>Following on from the code we evaluated before to set up the <code class="docutils literal"><span class="pre">synth</span></code></p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">; hello world as a list of note pitches</span>
<span class="c1">; transposed down two octaves (24 semitones)</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">melody</span> <span class="p">(</span><span class="k">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">c</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">-</span> <span class="p">(</span><span class="nf">char-&gt;integer</span> <span class="nv">c</span><span class="p">)</span> <span class="mi">24</span><span class="p">))</span>
                    <span class="p">(</span><span class="nf">string-&gt;list</span> <span class="s">&quot;Hello World!&quot;</span><span class="p">)))</span>

<span class="c1">; Define a recursive function to cycle through the pitches in melody</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">loop</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">pitch-list</span><span class="p">)</span>
      <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nf">null?</span> <span class="nv">pitch-list</span><span class="p">)</span> <span class="p">(</span><span class="nf">println</span> <span class="ss">&#39;done</span><span class="p">))</span>
            <span class="p">(</span><span class="k">else</span> <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">pitch-list</span><span class="p">)</span> <span class="mi">80</span> <span class="mi">10000</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">*second*</span> <span class="mf">0.5</span><span class="p">))</span>
                        <span class="p">(</span><span class="nf">cdr</span> <span class="nv">pitch-list</span><span class="p">))))))</span>

<span class="c1">; start playing melody</span>
<span class="p">(</span><span class="nv">loop</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">melody</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">loop</span></code> is a recursive function&#8212;it calls itself. If you look
carefully at the code for <code class="docutils literal"><span class="pre">loop</span></code> you&#8217;ll see that it takes a list of
pitches, schedules the playing of the first pitch, then calls itself
back with the remaining pitches (if there are any). When we call
<code class="docutils literal"><span class="pre">loop</span></code> in the last line with time and pitch-list arguments, we should
hear a sequence of pitches&#8212;and it turns out that &#8220;Hello World&#8221; doesn&#8217;t
make such a good musical example :)</p>
<p>Try evaluating the final <code class="docutils literal"><span class="pre">(loop</span> <span class="pre">(now)</span> <span class="pre">melody)</span></code> expression
repeatedly&#8212;don&#8217;t wait until the sequence has finished playing before you
trigger another one. Pretty cool, huh. Extempore is dynamic and
interactive and was developed for use in live performance.</p>
<p>Because coding in Extempore is so dynamic, if you re-evaluate a whole
buffer you may not get the results you expect! In particular, remember
that if you have multiple Extempore (<code class="docutils literal"><span class="pre">*.xtm</span></code>) file buffers connected
to the same <code class="docutils literal"><span class="pre">extempore</span></code> process then any evaluations you make will all
go to the same place. For example, there is only one <code class="docutils literal"><span class="pre">dsp</span></code> audio sink,
so if you try to evaluate two examples with different audio chain
configurations you will almost certainly not get what you expect. If in
doubt, a good idea (particularly when getting started) is to restart
Extempore each time you want to run a new example or start a new
project.</p>
<p>We can use these ideas to make more complex musical patterns, with
harmony, melody and rhythm as creative dimensions to explore.</p>
<p>It may seem a little strange when you first come to Extempore that
there are no &#8216;musical&#8217; functions provided for you&#8212;this is a
conscious decision. While it is impossible to provide a tool that does
not in some way influence its user, my goal with the <code class="docutils literal"><span class="pre">pc_ivl.xtm</span></code>
Scheme library provide a musical framework that&#8217;s as &#8216;unopinionated&#8217;
as possible. Of course this is a somewhat ridiculous statement given
that straight out of the gate Extempore&#8217;s use of MIDI note numbers for
pitches strongly preferences a traditional diatonic tonal system.
Having said that, as shown in <a class="reference internal" href="audio-signal-processing.html"><span class="doc">other guides</span></a>, you can generate tones of any
frequency&#8212;quarter tone composers should not despair!</p>
<p>So with these thoughts in mind I want to stress that this guide shows
<em>some</em> ways of representing musical processes &amp; data; not <em>the</em> way.
For example, MIDI pitch numbers are certainly not the only way to
represent or control pitch in Extempore&#8212;you are just as free to call
the xtlang function <code class="docutils literal"><span class="pre">_play_note</span></code> (which takes a frequency argument
in Hz) instead of the Scheme wrapper <code class="docutils literal"><span class="pre">play-note</span></code>. As I constantly
harp on about, it&#8217;s <em>xtlang turtles all the way down</em> with all the DSP
code I use in this guide, so if you want to hack them to suit your
needs you can&#8212;even in the middle of a performance. Still, the musical
frameworks exist so that you don&#8217;t <em>have to</em> do the low level DSP
stuff if you don&#8217;t want to, all you have to think about is writing
useful musical processes &amp; representations!</p>
<p>I should also note that most of the music libraries are written in
Scheme (rather than xtlang), and in fact most of the code in this guide
is also in Scheme. xtlang does have its own version of <code class="docutils literal"><span class="pre">callback</span></code>, so
you can also write temporal recursions in xtlang, but in this guide I&#8217;ve
chosen to use Scheme for most of the high-level &#8216;control&#8217; code (all the
DSP code being called is still in xtlang).</p>
<p>So enough with the lecture already! Let&#8217;s start by playing a sequence of
notes. Before we do that (if you haven&#8217;t already), you&#8217;ll have to set up
an instrument (in this case the built-in <code class="docutils literal"><span class="pre">synth</span></code>) and put it somewhere
in the <code class="docutils literal"><span class="pre">dsp</span></code> output callback:</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="nv">sys:load</span> <span class="s">&quot;libs/core/instruments.xtm&quot;</span><span class="p">)</span>

<span class="c1">;; define a synth using the provided components</span>
<span class="c1">;; synth_note_c and synth_fx</span>
<span class="p">(</span><span class="nv">bind-instrument</span> <span class="nv">synth</span> <span class="nv">synth_note_c</span> <span class="nv">synth_fx</span><span class="p">)</span>

<span class="c1">;; add the instrument to the DSP output sink closure</span>
<span class="p">(</span><span class="k">bind-func</span> <span class="nf">dsp</span><span class="kt">:DSP</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">synth</span> <span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">dsp:set!</span> <span class="nv">dsp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="playing-scales-and-chords">
<h2>Playing scales and chords<a class="headerlink" href="#playing-scales-and-chords" title="Permalink to this headline">¶</a></h2>
<p>First, let&#8217;s implement a simple iterative process. Remember that in MIDI
note numbers (which <code class="docutils literal"><span class="pre">play-note</span></code> uses) <code class="docutils literal"><span class="pre">60</span></code> is middle C, <code class="docutils literal"><span class="pre">61</span></code> is
C#, <code class="docutils literal"><span class="pre">62</span></code> is D, etc...</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="k">do</span><span class="nv">times</span> <span class="p">(</span><span class="nv">i</span> <span class="mi">8</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="mi">5000</span><span class="p">))</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">60</span> <span class="nv">i</span><span class="p">)</span> <span class="mi">80</span> <span class="mi">4000</span><span class="p">))</span>
</pre></div>
</div>
<p>That seems simple enough. But there is a problem here&#8212;we don&#8217;t have any
control over the iterator variable <code class="docutils literal"><span class="pre">i</span></code> in the <code class="docutils literal"><span class="pre">dotimes</span></code> loop. What
if we want to play a whole tone scale. Let&#8217;s use recursion to solve this
problem. Ok Scheme newbies, time find out about <a class="reference external" href="http://www.scheme.com/tspl3/control.html#g90">named</a> <code class="docutils literal"><span class="pre">let</span></code>!</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; recursive whole-tone scale</span>
<span class="p">(</span><span class="k">let</span> <span class="nv">loop</span> <span class="p">((</span><span class="nv">i</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="mi">2500</span><span class="p">))</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">60</span> <span class="nv">i</span><span class="p">)</span> <span class="mi">80</span> <span class="mi">4000</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">&lt;</span> <span class="nv">i</span> <span class="mi">9</span><span class="p">)</span> <span class="p">(</span><span class="nv">loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">i</span> <span class="mi">2</span><span class="p">))))</span>
</pre></div>
</div>
<p>I&#8217;m sure there are a few people whispering <em>he could have done that
with</em> <code class="docutils literal"><span class="pre">dotimes</span></code>, but this is Scheme, so the quicker we move onto
recursion the better :)</p>
<p>So, linear sequences don&#8217;t seem to present a problem. How about a major
scale? Recursion can handle this for us</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; recursive major scale</span>
<span class="p">(</span><span class="k">let</span> <span class="nv">loop</span> <span class="p">((</span><span class="nv">scale</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span> <span class="mi">12</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">time</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">scale</span><span class="p">))</span> <span class="mi">80</span> <span class="mi">4000</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">not</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">scale</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">loop</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">scale</span><span class="p">)</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">5000</span><span class="p">))))</span>
</pre></div>
</div>
<p>We also added a second argument to loop: <code class="docutils literal"><span class="pre">time</span></code>. Let&#8217;s use the
<code class="docutils literal"><span class="pre">time</span></code> argument to add changing durations to our scale.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; recursive major scale with rhythm</span>
<span class="p">(</span><span class="k">let</span> <span class="nv">loop</span> <span class="p">((</span><span class="nv">scale</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span> <span class="mi">12</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">dur</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">22050</span> <span class="mi">11025</span> <span class="mi">11025</span> <span class="mi">22050</span> <span class="mi">11025</span> <span class="mi">11025</span> <span class="mi">44100</span> <span class="mi">44100</span><span class="p">))</span>
           <span class="p">(</span><span class="nv">time</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">scale</span><span class="p">))</span> <span class="mi">80</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">dur</span><span class="p">))</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">not</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">scale</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">loop</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">scale</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">dur</span><span class="p">)</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">dur</span><span class="p">)))))</span>
</pre></div>
</div>
<p>Now that we have pitches and rhythms mastered how do we go about playing
a chord? The new <code class="docutils literal"><span class="pre">time</span></code> argument from the previous examples should
give you a pretty good clue&#8212;we just ditch the <code class="docutils literal"><span class="pre">time</span></code> argument!</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; recursive chord</span>
<span class="p">(</span><span class="k">let</span> <span class="nv">loop</span> <span class="p">((</span><span class="nv">chord</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">chord</span><span class="p">))</span> <span class="mi">80</span> <span class="mi">44100</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">not</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">chord</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">loop</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">chord</span><span class="p">))))</span>

<span class="c1">;; we could also write this</span>
<span class="p">(</span><span class="k">let</span> <span class="nv">loop</span> <span class="p">((</span><span class="nv">scale</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nf">null?</span> <span class="nv">scale</span><span class="p">)</span> <span class="ss">&#39;finished</span><span class="p">)</span>
        <span class="p">(</span><span class="k">else</span> <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">scale</span><span class="p">))</span> <span class="mi">80</span> <span class="mi">44100</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">loop</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">scale</span><span class="p">)))))</span>
</pre></div>
</div>
<p>C Major&#8212;nice! We seem to be using lists a lot, so you&#8217;re probably just
dying to use <code class="docutils literal"><span class="pre">map</span></code>, so here goes.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; map calls lambda for each argument of list</span>
<span class="p">(</span><span class="k">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">synth</span> <span class="nv">p</span> <span class="mi">80</span> <span class="mi">44100</span><span class="p">))</span>
     <span class="p">(</span><span class="nf">list</span> <span class="mi">60</span> <span class="mi">63</span> <span class="mi">67</span><span class="p">))</span>
</pre></div>
</div>
<p>C minor that time, that&#8217;s cool. That way is much more concise, why don&#8217;t
we always use <code class="docutils literal"><span class="pre">map</span></code>? There are a couple of reasons why sometimes it&#8217;s
better not to use <code class="docutils literal"><span class="pre">map</span></code> but we&#8217;ll come to those soon enough. For the
moment let&#8217;s look at how we can use <code class="docutils literal"><span class="pre">map</span></code> to play a broken chord.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; map broken chord</span>
<span class="p">(</span><span class="k">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span> <span class="nv">d</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">d</span><span class="p">)</span> <span class="nv">synth</span> <span class="nv">p</span> <span class="mi">80</span> <span class="p">(</span><span class="nf">-</span> <span class="mi">88200</span> <span class="nv">d</span><span class="p">)))</span>
     <span class="p">(</span><span class="nf">list</span> <span class="mi">60</span> <span class="mi">64</span> <span class="mi">67</span><span class="p">)</span>
     <span class="p">(</span><span class="nf">list</span> <span class="mi">0</span> <span class="mi">22050</span> <span class="mi">44100</span><span class="p">))</span>
</pre></div>
</div>
<p>One small thing to keep in mind: <code class="docutils literal"><span class="pre">map</span></code> is designed to return a new
list of values. The process of creating this list makes <code class="docutils literal"><span class="pre">map</span></code> slightly
less efficient than the function <code class="docutils literal"><span class="pre">for-each</span></code>, which is not specified to
return a list but is instead designed specifically to trigger side
effects (i.e. playing notes in this instance). So if you don&#8217;t need to
return a list, use <code class="docutils literal"><span class="pre">for-each</span></code> instead of <code class="docutils literal"><span class="pre">map</span></code>.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; for-each broken chord with volumes</span>
<span class="p">(</span><span class="k">for-each</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span> <span class="nv">d</span> <span class="nv">v</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">d</span><span class="p">)</span> <span class="nv">synth</span> <span class="nv">p</span> <span class="nv">v</span> <span class="p">(</span><span class="nf">-</span> <span class="mi">88200</span> <span class="nv">d</span><span class="p">)))</span>
          <span class="p">(</span><span class="nf">list</span> <span class="mi">60</span> <span class="mi">64</span> <span class="mi">67</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">list</span> <span class="mi">0</span> <span class="mi">22050</span> <span class="mi">44100</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">list</span> <span class="mi">90</span> <span class="mi">50</span> <span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
<p>Ok, now we&#8217;ve covered the basics. Before we move on, if you haven&#8217;t read
the time tutorial it&#8217;s probably a good idea to go and read it now.</p>
</div>
<div class="section" id="temporal-recursion">
<h2>Temporal recursion<a class="headerlink" href="#temporal-recursion" title="Permalink to this headline">¶</a></h2>
<p>If you have already read <a class="reference internal" href="time.html"><span class="doc">Time in Extempore</span></a>, you&#8217;ll be all set to start using
<code class="docutils literal"><span class="pre">callback</span></code>. We&#8217;ve already looked at various ways to play a sequence
of notes, and we&#8217;re now going to expand on that theme. Let&#8217;s define a
function that uses <code class="docutils literal"><span class="pre">callback</span></code> to temporally recurse through a list
of pitch values.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; plays a sequence of pitches</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">play-seq</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">plst</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">plst</span><span class="p">)</span> <span class="mi">80</span> <span class="mi">11025</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">not</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">10000</span><span class="p">)</span> <span class="ss">&#39;play-seq</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">11025</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">play-seq</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">63</span> <span class="mi">65</span> <span class="mi">67</span> <span class="mi">68</span> <span class="mi">71</span> <span class="mi">72</span><span class="p">))</span>
</pre></div>
</div>
<p>This should look very similar to the example in the previous section,
but there are some subtle differences. To demonstrate, let&#8217;s change
<code class="docutils literal"><span class="pre">play-seq</span></code> so that it keeps playing the sequence indefinitely.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; loop over a sequence of pitches indefinitely</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">play-seq</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">plst</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">plst</span><span class="p">)</span> <span class="mi">80</span> <span class="mi">11025</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">10000</span><span class="p">)</span> <span class="ss">&#39;play-seq</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">11025</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">65</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">10000</span><span class="p">)</span> <span class="ss">&#39;play-seq</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">11025</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">play-seq</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">65</span><span class="p">))</span>
</pre></div>
</div>
<p>Ok, now while <code class="docutils literal"><span class="pre">play-seq</span></code> is running, change the <code class="docutils literal"><span class="pre">(60</span> <span class="pre">62</span> <span class="pre">65)</span></code> (in the
body of the <code class="docutils literal"><span class="pre">play-seq</span></code> function) to <code class="docutils literal"><span class="pre">(60</span> <span class="pre">62</span> <span class="pre">67)</span></code> and re-evaluate the
<code class="docutils literal"><span class="pre">play-seq</span></code> function. Now try changing it to <code class="docutils literal"><span class="pre">(60</span> <span class="pre">62</span> <span class="pre">67</span> <span class="pre">69)</span></code> and
re-evaluating. Because <code class="docutils literal"><span class="pre">play-seq</span></code> uses this list to reinitialize
<code class="docutils literal"><span class="pre">plst</span></code> whenever <code class="docutils literal"><span class="pre">plst</span></code> is null, any changes we make are reflected
when this re-initialization occurs&#8212;a useful little trick. Stop the
play-seq function by re-defining play-seq to be the function that does
nothing: <code class="docutils literal"><span class="pre">(define</span> <span class="pre">play-seq</span> <span class="pre">(lambda</span> <span class="pre">args))</span></code>.</p>
<p>Let&#8217;s extend <code class="docutils literal"><span class="pre">play-seq</span></code> to include a rhythm list (<code class="docutils literal"><span class="pre">rlst</span></code>) as well.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; plays a sequence of pitches</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">play-seq</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">plst</span> <span class="nv">rlst</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">plst</span><span class="p">)</span> <span class="mi">80</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">)))</span> <span class="ss">&#39;play-seq</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">))</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">))</span>
                  <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">65</span> <span class="mi">69</span> <span class="mi">67</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">))</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">rlst</span><span class="p">))</span>
                  <span class="o">&#39;</span><span class="p">(</span><span class="mi">11025</span> <span class="mi">11025</span> <span class="mi">22050</span> <span class="mi">11025</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">rlst</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">play-seq</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">65</span> <span class="mi">69</span> <span class="mi">67</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">11025</span> <span class="mi">11025</span> <span class="mi">22050</span> <span class="mi">11025</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that our pitch list and our rhythm list are different lengths.
Unlike <code class="docutils literal"><span class="pre">for-each</span></code> (and <code class="docutils literal"><span class="pre">map</span></code>) we can iterate through these two lists
<em>independently</em>, so they can be of different lengths. This allows us to
play with various phasing techniques. Have a play, change the
lengths/values of both lists inside the <code class="docutils literal"><span class="pre">play-seq</span></code> function, and
remember to re-evaluate <code class="docutils literal"><span class="pre">play-seq</span></code> when you are ready for your changes
to take effect. Try calling <code class="docutils literal"><span class="pre">play-seq</span></code> again to start a second
sequence playing. Try to create a nice offset&#8212;you&#8217;ll need to evaluate
the code at just the right time :) Note that after the first iteration
through the sequence, both running instances of <code class="docutils literal"><span class="pre">play-seq</span></code> will assume
the same lists (because <code class="docutils literal"><span class="pre">callback</span></code> sets the same list values when it&#8217;s
time to reinitialize the lists). As an exercise for the reader, think
about how you could avoid that problem (i.e. keep the lists independent
for each instance of <code class="docutils literal"><span class="pre">play-seq</span></code>).</p>
<p>Ok, so we can now <em>manually</em> change the lists that <code class="docutils literal"><span class="pre">play-seq</span></code> cycles
through, but what if we would like to change the list programmatically.
No problem, just use a function instead of a literal list&#8212;of course this
is now no longer an ostinati!</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; plays a random pentatonic sequence of notes</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">play-seq</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">plst</span> <span class="nv">rlst</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">plst</span><span class="p">)</span> <span class="mi">80</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">65</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">)))</span> <span class="ss">&#39;play-seq</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">))</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">))</span>
                  <span class="p">(</span><span class="nv">make-list-with-proc</span> <span class="mi">4</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nf">random</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">64</span> <span class="mi">67</span> <span class="mi">69</span><span class="p">))))</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">))</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">rlst</span><span class="p">))</span>
                  <span class="p">(</span><span class="nv">make-list</span> <span class="mi">4</span> <span class="mi">11025</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">rlst</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">play-seq</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">64</span> <span class="mi">67</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">11025</span><span class="p">))</span>
</pre></div>
</div>
<p>One final performance tip before we move on&#8212;musical performance of
course! It&#8217;s really easy to add some metric interest by oscillating the
volume to peak on down beats. We can make a small modification to the
previous example to demonstrate this simple little cheat. Also we&#8217;ll
shorten the durations a little (constant legato gets a touch boring).</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; plays a random pentatonic sequence of notes with a metric pulse</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">play-seq</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">plst</span> <span class="nv">rlst</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">plst</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">+</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">50</span> <span class="p">(</span><span class="nf">cos</span> <span class="p">(</span><span class="nf">*</span> <span class="mf">0.03125</span> <span class="mf">3.141592</span> <span class="nv">time</span><span class="p">))))</span>
               <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">65</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">)))</span> <span class="ss">&#39;play-seq</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">))</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">))</span>
                  <span class="p">(</span><span class="nv">make-list-with-proc</span> <span class="mi">4</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nf">random</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">64</span> <span class="mi">67</span> <span class="mi">69</span><span class="p">))))</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">plst</span><span class="p">))</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">rlst</span><span class="p">))</span>
                  <span class="p">(</span><span class="nv">make-list</span> <span class="mi">4</span> <span class="mi">11025</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">rlst</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">play-seq</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span> <span class="mi">62</span> <span class="mi">64</span> <span class="mi">67</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">11025</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="pitch-classes">
<h2>Pitch classes<a class="headerlink" href="#pitch-classes" title="Permalink to this headline">¶</a></h2>
<p>If you&#8217;ve read many 20th Century composition texts on <a class="reference external" href="http://en.wikipedia.org/wiki/Pitch_class">pitch classes</a>,
you could be forgiven for thinking pitch class sets a rather dry subject
and of limited compositional value. Oh, how wrong you would be! Pitch
classes are actually not too tricky to understand and fantastically
useful for the music programmer.</p>
<p>For those unfamiliar with pitch classes, they are based around the 12
semitones of the chromatic scale, and each semitone is given it&#8217;s own
class: C, C#, D, D#/Eb, F, F# etc. Pitch classes also remove all octave
reference and <a class="reference external" href="http://en.wikipedia.org/wiki/Enharmonic">enharmonic</a> signature, because pitch classes display
enharmonic and octave equivalence (i.e. D#/Eb are the same pitch class
in any octave). Of course in a programming space we use numbers to
represent pitches, because numbers are easier for us to work with. So,
instead of B#/C/Db for example we use <code class="docutils literal"><span class="pre">0</span></code>, C#/Db is <code class="docutils literal"><span class="pre">1</span></code>, D is
<code class="docutils literal"><span class="pre">2</span></code>... through to A#/B/Cb at <code class="docutils literal"><span class="pre">11</span></code> which rounds out the complete set
of available pitch classes <code class="docutils literal"><span class="pre">0</span></code> to <code class="docutils literal"><span class="pre">11</span></code>.</p>
<p>Now, the observant reader will note that we can use modulo arithmetic to
find MIDI pitches of octave equivalence by using mod <code class="docutils literal"><span class="pre">12</span></code>. Try running
this example, and check the log for the printed results.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="k">do</span><span class="nv">times</span> <span class="p">(</span><span class="nv">i</span> <span class="mi">12</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">println</span> <span class="ss">&#39;modulo</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">i</span> <span class="mi">60</span><span class="p">)</span> <span class="mi">12</span> <span class="ss">&#39;=&gt;</span> <span class="p">(</span><span class="nf">modulo</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">i</span> <span class="mi">60</span><span class="p">)</span> <span class="mi">12</span><span class="p">)))</span>
</pre></div>
</div>
<p>Now, as previously discussed, Extempore does not include (by default)
much high-level musical support. However, there is pitch class (Scheme)
library in <code class="docutils literal"><span class="pre">libs/core/pc_ivl.xtm</span></code>. I encourage you to take a look at
the <code class="docutils literal"><span class="pre">pc_ivl.xtm</span></code> file and extend and replace things as you see
fit&#8212;you&#8217;ll probably have your own preferred way of working with pitch
classes.</p>
<p>Let&#8217;s start with something simple. We can define a pitch class set by
creating a list of pitch classes that belong to the set. We can then
test a pitch against that set by using <code class="docutils literal"><span class="pre">pc:?</span></code></p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="nv">sys:load</span> <span class="s">&quot;libs/core/pc_ivl.xtm&quot;</span><span class="p">)</span>

<span class="c1">;; four examples tested against the pitch class set representation of a C major chord</span>
<span class="p">(</span><span class="nv">pc:?</span> <span class="mi">60</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">))</span>
<span class="p">(</span><span class="nv">pc:?</span> <span class="mi">84</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">))</span>
<span class="p">(</span><span class="nv">pc:?</span> <span class="mi">35</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">))</span>
<span class="p">(</span><span class="nv">pc:?</span> <span class="mi">79</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">))</span>
</pre></div>
</div>
<p>We can also choose a random pitch from a pitch class set between a lower
and upper bound.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; this chooses a C in any octave</span>
<span class="p">(</span><span class="nv">pc:random</span> <span class="mi">0</span> <span class="mi">127</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="c1">;; this chooses any note from a D minor chord in octave 4</span>
<span class="p">(</span><span class="nv">pc:random</span> <span class="mi">60</span> <span class="mi">73</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="mi">5</span> <span class="mi">9</span><span class="p">))</span>

<span class="c1">;; this chooses any note from a C pentatonic octaves 3-6</span>
<span class="p">(</span><span class="nv">pc:random</span> <span class="mi">48</span> <span class="mi">97</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">7</span> <span class="mi">9</span><span class="p">))</span>
</pre></div>
</div>
<p>Let&#8217;s write a little organum piece. We&#8217;re going to write a strict
parallel organum where we take a melody part and then transpose up a
perfect forth or fifth (you can try both) to supply a harmony. What does
this have to do with pitch classes? Well, you can&#8217;t just transpose up a
fifth by adding 7 to everything:</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; up 7 semitones or a perfect fifth</span>
<span class="p">(</span><span class="k">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">pc:?</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">p</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">)))</span>
     <span class="p">(</span><span class="nf">list</span> <span class="mi">60</span> <span class="mi">62</span> <span class="mi">64</span> <span class="mi">65</span> <span class="mi">67</span> <span class="mi">69</span> <span class="mi">71</span><span class="p">))</span>

<span class="c1">;; up 5 semitones or a perfect forth</span>
<span class="p">(</span><span class="k">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">pc:?</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">p</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">)))</span>
     <span class="p">(</span><span class="nf">list</span> <span class="mi">60</span> <span class="mi">62</span> <span class="mi">64</span> <span class="mi">65</span> <span class="mi">67</span> <span class="mi">69</span> <span class="mi">71</span><span class="p">))</span>

<span class="c1">;; up 4 semitones or a major third</span>
<span class="p">(</span><span class="k">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">pc:?</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">p</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">)))</span>
     <span class="p">(</span><span class="nf">list</span> <span class="mi">60</span> <span class="mi">62</span> <span class="mi">64</span> <span class="mi">65</span> <span class="mi">67</span> <span class="mi">69</span> <span class="mi">71</span><span class="p">))</span>
</pre></div>
</div>
<p>Based on a C-major key pitch class set, <code class="docutils literal"><span class="pre">B</span></code> up 7 semitones (a perfect
5th) gives us <code class="docutils literal"><span class="pre">F#</span></code>. <code class="docutils literal"><span class="pre">F</span></code> up by 5 semitones (a perfect 4th) gives
<code class="docutils literal"><span class="pre">Bb</span></code> and if we have the audacity to try 4 semitones (a major 3rd)&#8212;well
basically nothing works. Notice that we do use map here instead of
for-each because we <em>do</em> want to return a list (of boolean values). So
the answer is to use <code class="docutils literal"><span class="pre">pc:relative</span></code>, which will choose a pitch value
from the pitch class relative to our current pitch.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; this gives us 62</span>
<span class="p">(</span><span class="nv">pc:relative</span> <span class="mi">60</span> <span class="mi">1</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">))</span>

<span class="c1">;; this gives us 67</span>
<span class="p">(</span><span class="nv">pc:relative</span> <span class="mi">60</span> <span class="mi">4</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">))</span>

<span class="c1">;; this gives us 67 as well</span>
<span class="p">(</span><span class="nv">pc:relative</span> <span class="mi">67</span> <span class="mi">0</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">))</span>

<span class="c1">;; this gives us 57 (yes you can go backwards)</span>
<span class="p">(</span><span class="nv">pc:relative</span> <span class="mi">60</span> <span class="mi">-2</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">))</span>
</pre></div>
</div>
<p>One more rule about an organum: we need our melody and harmony to start
and finish on the same note (C). Here&#8217;s one way we could go about the
task:</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; define a melody</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">melody</span> <span class="p">(</span><span class="nv">make-list-with-proc</span> <span class="mi">24</span>
                                    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">i</span><span class="p">)</span>
                                      <span class="p">(</span><span class="nv">pc:random</span> <span class="mi">60</span> <span class="mi">73</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">)))))</span>

<span class="c1">;; define harmony up a perfect 5th (4 places away in the pitch class set)</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">harmony</span> <span class="p">(</span><span class="k">map</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
                       <span class="p">(</span><span class="nv">pc:relative</span> <span class="nv">p</span> <span class="mi">4</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">)))</span>
                     <span class="nv">melody</span><span class="p">))</span>

<span class="c1">;; set c at start and end</span>
<span class="p">(</span><span class="k">set!</span> <span class="nv">melody</span> <span class="p">(</span><span class="nf">cons</span> <span class="mi">60</span> <span class="nv">melody</span><span class="p">))</span>
<span class="p">(</span><span class="k">set!</span> <span class="nv">harmony</span> <span class="p">(</span><span class="nf">cons</span> <span class="mi">60</span> <span class="nv">harmony</span><span class="p">))</span>
<span class="p">(</span><span class="k">set!</span> <span class="nv">melody</span> <span class="p">(</span><span class="nf">reverse</span> <span class="p">(</span><span class="nf">cons</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">reverse</span> <span class="nv">melody</span><span class="p">))))</span>
<span class="p">(</span><span class="k">set!</span> <span class="nv">harmony</span> <span class="p">(</span><span class="nf">reverse</span> <span class="p">(</span><span class="nf">cons</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">reverse</span> <span class="nv">harmony</span><span class="p">))))</span>

<span class="c1">;; random rhythm</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">rhythm</span> <span class="p">(</span><span class="nv">make-list-with-proc</span> <span class="mi">24</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nf">random</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">44100</span> <span class="mi">22050</span><span class="p">)))))</span>

<span class="c1">;; set long start and end to rhythm</span>
<span class="p">(</span><span class="k">set!</span> <span class="nv">rhythm</span> <span class="p">(</span><span class="nf">cons</span> <span class="mi">88200</span> <span class="nv">rhythm</span><span class="p">))</span>
<span class="p">(</span><span class="k">set!</span> <span class="nv">rhythm</span> <span class="p">(</span><span class="nf">reverse</span> <span class="p">(</span><span class="nf">cons</span> <span class="mi">88200</span> <span class="p">(</span><span class="nf">reverse</span> <span class="nv">rhythm</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">organum</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">mlst</span> <span class="nv">hlst</span> <span class="nv">rlst</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">mlst</span><span class="p">)</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">hlst</span><span class="p">)</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">not</span> <span class="p">(</span><span class="nf">null?</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">mlst</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">)))</span> <span class="ss">&#39;organum</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">rlst</span><span class="p">))</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">mlst</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">hlst</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">cdr</span> <span class="nv">rlst</span><span class="p">)))))</span>

<span class="c1">;; start</span>
<span class="p">(</span><span class="k">or</span><span class="nv">ganum</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="nv">melody</span> <span class="nv">harmony</span> <span class="nv">rhythm</span><span class="p">)</span>
</pre></div>
</div>
<p>It was a little out of character for the melody to leap around so much,
so let&#8217;s also use <code class="docutils literal"><span class="pre">pc:relative</span></code> to implement a random walk melody. The
rest of the code can stay the same, but remember to reevaluate
everything that the change effects&#8212;in this case everything to do with
creating <code class="docutils literal"><span class="pre">melody</span></code> and <code class="docutils literal"><span class="pre">harmony</span></code>.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; define a random walk melody seeded with 60</span>
<span class="c1">;; (we remove this at the end with cdr)</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">melody</span>
  <span class="p">(</span><span class="k">let</span> <span class="nv">loop</span> <span class="p">((</span><span class="nv">i</span> <span class="mi">0</span><span class="p">)</span>
             <span class="p">(</span><span class="nv">lst</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">60</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">&lt;</span> <span class="nv">i</span> <span class="mi">24</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">i</span> <span class="mi">1</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">cons</span> <span class="p">(</span><span class="nv">pc:relative</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">lst</span><span class="p">)</span>
                                 <span class="p">(</span><span class="nf">random</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">-1</span> <span class="mi">1</span><span class="p">))</span>
                                 <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">))</span>
                    <span class="nv">lst</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">reverse</span> <span class="nv">lst</span><span class="p">)))))</span>
</pre></div>
</div>
<p>Of course we could easily use larger leaps by changing <code class="docutils literal"><span class="pre">(random</span> <span class="pre">'(-1</span>
<span class="pre">1))</span></code> to <code class="docutils literal"><span class="pre">(random</span> <span class="pre">'(-2</span> <span class="pre">-1</span> <span class="pre">1</span> <span class="pre">2</span> <span class="pre">3))</span></code> for example. <code class="docutils literal"><span class="pre">pc:relative</span></code> can be
a useful way of constraining (and then later releasing) melodic
invention.</p>
</div>
<div class="section" id="making-chords-with-pitch-classes">
<h2>Making chords with pitch classes<a class="headerlink" href="#making-chords-with-pitch-classes" title="Permalink to this headline">¶</a></h2>
<p>Ok, that&#8217;s enough 13thC noise, let&#8217;s go hard core 20thC and make a <code class="docutils literal"><span class="pre">I</span></code>
<code class="docutils literal"><span class="pre">IV</span></code> <code class="docutils literal"><span class="pre">V</span></code> progression :) But first a crazy 21stC chord. Once
<code class="docutils literal"><span class="pre">crazy-chord</span></code> is running, slowly start removing pitch classes from the
end of the set. And just a heads up&#8212;I&#8217;m not going to remind you to
re-evaluate anymore :) Listen to the C-major chord that starts to
evolve. If your machine will handle a higher callback rate then go for
it, we&#8217;re after a wash of sound here. Try choosing a sound with a delay
for extra impact.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="k">define</span> <span class="nv">crazy-chord</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="p">(</span><span class="nv">pc:random</span> <span class="mi">24</span> <span class="mi">97</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span> <span class="mi">10</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">5</span> <span class="mi">9</span> <span class="mi">6</span> <span class="mi">11</span> <span class="mi">1</span><span class="p">))</span> <span class="mi">80</span> <span class="mi">500</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">1000</span><span class="p">)</span> <span class="ss">&#39;crazy-chord</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">2000</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">crazy-chord</span> <span class="p">(</span><span class="nf">now</span><span class="p">))</span>
</pre></div>
</div>
<p>Ok, so we&#8217;ve seen how we can use a pitch class to represent a chord.
<code class="docutils literal"><span class="pre">pc_ivl.xtm</span></code> also includes a useful little function <code class="docutils literal"><span class="pre">pc:make-chord</span></code>
for returning a &#8216;random&#8217; chord based on a pitch class set. Let&#8217;s take a
look at this in action:</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; C-major and repeat</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">chords</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span><span class="p">)</span>
    <span class="p">(</span><span class="k">for-each</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="nv">p</span> <span class="mi">80</span> <span class="mi">10000</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">pc:make-chord</span> <span class="mi">60</span> <span class="mi">72</span> <span class="mi">3</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">10000</span><span class="p">)</span> <span class="ss">&#39;chords</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">11025</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">chords</span> <span class="p">(</span><span class="nf">now</span><span class="p">))</span>
</pre></div>
</div>
<p>Hey, our friend <code class="docutils literal"><span class="pre">for-each</span></code> is back. Now while <code class="docutils literal"><span class="pre">chords</span></code> is playing,
start expanding the range (i.e. drop the <code class="docutils literal"><span class="pre">60</span></code> down and raise the
<code class="docutils literal"><span class="pre">72</span></code> up). <code class="docutils literal"><span class="pre">pc:make-chord</span></code> returns as many notes as we request in the
3rd (<code class="docutils literal"><span class="pre">number</span></code>) argument, which is <code class="docutils literal"><span class="pre">3</span></code> in the example above. It tries
to evenly distribute the notes of the chord across the specified range.
It also attempts to use each class in the pitch class set. However, it
does not make any guarantees about what order to choose classes from the
pitch class set. You might also like to change the number of notes being
generated for our chord&#8212;try changing <code class="docutils literal"><span class="pre">3</span></code> to <code class="docutils literal"><span class="pre">1</span></code>, or <code class="docutils literal"><span class="pre">2</span></code>, <code class="docutils literal"><span class="pre">4</span></code>,
<code class="docutils literal"><span class="pre">5</span></code>...</p>
<p>I&#8217;m getting a little sick of C-major, so let&#8217;s add chord <code class="docutils literal"><span class="pre">IV</span></code> (F
major) and <code class="docutils literal"><span class="pre">V</span></code> (G major) to the progression and make a random chord
change one in five callbacks. Note that <code class="docutils literal"><span class="pre">random</span></code> can just as easily
choose a <em>list</em> from a list as an <em>atom</em> from a list.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; I IV V</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">chords</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">chord</span><span class="p">)</span>
    <span class="p">(</span><span class="k">for-each</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="nv">p</span> <span class="mi">80</span> <span class="mi">10000</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">pc:make-chord</span> <span class="mi">48</span> <span class="mi">90</span> <span class="mi">3</span> <span class="nv">chord</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">10000</span><span class="p">)</span> <span class="ss">&#39;chords</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">11025</span><span class="p">)</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="p">(</span><span class="nf">random</span><span class="p">)</span> <span class="o">.</span><span class="mi">8</span><span class="p">)</span>
                  <span class="p">(</span><span class="nf">random</span> <span class="o">&#39;</span><span class="p">((</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">)</span> <span class="p">(</span><span class="mi">5</span> <span class="mi">9</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="mi">7</span> <span class="mi">11</span> <span class="mi">2</span><span class="p">)))</span>
                  <span class="nv">chord</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">chords</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">))</span>
</pre></div>
</div>
<p>There&#8217;s a lot more we can do with pitch classes. You can go and explore
right now if you like, and there&#8217;s also plenty more to come in this guide
too.</p>
</div>
<div class="section" id="harmony">
<h2>Harmony<a class="headerlink" href="#harmony" title="Permalink to this headline">¶</a></h2>
<p>Time to move onto some serious composition, and what could be more
serious than diatonic harmony :)</p>
<p>Now everyone knows that you don&#8217;t follow <code class="docutils literal"><span class="pre">V</span></code> with <code class="docutils literal"><span class="pre">ii</span></code>, at least
this is probably what your music teacher tried to tell you :) 18thC
Harmony lessons aside, it <em>is</em> worth questioning the validity of making
random chord changes a progression.</p>
<p>A Russian mathematician named Andrey Markov came up with one neat
solution which we&#8217;re going to pinch (he was actually interested in
russian language usage, but hey whatever). His work stated that you can
construct a probability matrix that outlines the probability of any new
state occurring based on a current state.</p>
<p>So let&#8217;s look at a very traditional picture (for simplicity&#8217;s sake) of
Western Diatonic Harmony. Remembering that in the major key our scale
degrees give us the following chords: <code class="docutils literal"><span class="pre">I</span></code>, <code class="docutils literal"><span class="pre">ii</span></code>, <code class="docutils literal"><span class="pre">iii</span></code>, <code class="docutils literal"><span class="pre">IV</span></code>,
<code class="docutils literal"><span class="pre">V</span></code>, <code class="docutils literal"><span class="pre">vi</span></code>, and <code class="docutils literal"><span class="pre">viio</span></code>. Roman uppercase letters are major chords,
roman lowercase are minor chords, and <code class="docutils literal"><span class="pre">viio</span></code> is a diminished chord.
When we add the circle of 5ths into the mix, we end up with a chord
progression chart that in it&#8217;s simplest form looks something like this
(I&#8217;ve taken a few liberties based on a few hundred years of usage).</p>
<img alt="_images/markov-matrix.png" src="_images/markov-matrix.png" />
<p>So reading this diagram from left to right we can move from <code class="docutils literal"><span class="pre">iii</span></code> to
<code class="docutils literal"><span class="pre">vi</span></code>. Then from <code class="docutils literal"><span class="pre">vi</span></code> to either <code class="docutils literal"><span class="pre">IV</span></code> or <code class="docutils literal"><span class="pre">ii</span></code>. From <code class="docutils literal"><span class="pre">IV</span></code> we can
then move to either <code class="docutils literal"><span class="pre">viio</span></code>, <code class="docutils literal"><span class="pre">ii</span></code>, <code class="docutils literal"><span class="pre">V</span></code> or <code class="docutils literal"><span class="pre">I</span></code>. From <code class="docutils literal"><span class="pre">ii</span></code> we can
move to either <code class="docutils literal"><span class="pre">viio</span></code> or <code class="docutils literal"><span class="pre">V</span></code>. From <code class="docutils literal"><span class="pre">viio</span></code> we can move to <code class="docutils literal"><span class="pre">V</span></code> or
<code class="docutils literal"><span class="pre">I</span></code>. From <code class="docutils literal"><span class="pre">V</span></code> we can move to either <code class="docutils literal"><span class="pre">vi</span></code> or <code class="docutils literal"><span class="pre">I</span></code>. And from <code class="docutils literal"><span class="pre">I</span></code>
we can move anywhere&#8212;however in the matrix above I have limited
<code class="docutils literal"><span class="pre">I</span></code>&#8216;s movement to <code class="docutils literal"><span class="pre">iii</span></code> <code class="docutils literal"><span class="pre">IV</span></code> <code class="docutils literal"><span class="pre">V</span></code> and <code class="docutils literal"><span class="pre">vi</span></code>. This is a pretty
limited view of the harmonic world, but we&#8217;ll stick with it for today.</p>
<p>Now for the cool part: we can use <code class="docutils literal"><span class="pre">random</span></code> and <code class="docutils literal"><span class="pre">assoc</span></code> to trivially
implement this markov matrix in Extempore (if you don&#8217;t know what
<code class="docutils literal"><span class="pre">assoc</span></code> does then Dybvig&#8217;s <a class="reference external" href="http://www.scheme.com/tspl3/objects.html">The Scheme Programming Language</a> is a
good online resource). For this first effort we&#8217;re going to assume the
key of C major and I&#8217;m going to limit the example to the <code class="docutils literal"><span class="pre">I</span></code>, <code class="docutils literal"><span class="pre">IV</span></code>
and <code class="docutils literal"><span class="pre">V</span></code> chords only.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; markov chord progression I IV V</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">progression</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">chord</span><span class="p">)</span>
    <span class="p">(</span><span class="k">for-each</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="nv">p</span> <span class="mi">80</span> <span class="mi">40000</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">pc:make-chord</span> <span class="mi">60</span> <span class="mi">73</span> <span class="mi">3</span> <span class="nv">chord</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">40000</span><span class="p">)</span> <span class="ss">&#39;progression</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">44100</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">assoc</span> <span class="nv">chord</span> <span class="o">&#39;</span><span class="p">(((</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">)</span> <span class="p">(</span><span class="mi">5</span> <span class="mi">9</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="mi">7</span> <span class="mi">11</span> <span class="mi">2</span><span class="p">))</span>
                                          <span class="p">((</span><span class="mi">5</span> <span class="mi">9</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="mi">7</span> <span class="mi">11</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">))</span>
                                          <span class="p">((</span><span class="mi">7</span> <span class="mi">11</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">)))))))))</span>

<span class="p">(</span><span class="nv">progression</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">4</span> <span class="mi">7</span><span class="p">))</span>
</pre></div>
</div>
<p>Now that was pretty easy, but our list of chords is a little unwieldy.
Fortunately <code class="docutils literal"><span class="pre">pc_ivl.xtm</span></code> has a function that will help us out with
that problem. <code class="docutils literal"><span class="pre">pc:diatonic</span></code> is designed to return a chord&#8217;s pitch
class given a key and a scale degree. So if we use <code class="docutils literal"><span class="pre">(pc:diatonic</span> <span class="pre">0</span> <span class="pre">'^</span>
<span class="pre">'iii)</span></code> we are asking for <code class="docutils literal"><span class="pre">iii</span></code> in the key of C (<code class="docutils literal"><span class="pre">0</span></code>) major (<code class="docutils literal"><span class="pre">^</span></code>).
<code class="docutils literal"><span class="pre">^</span></code> is major and <code class="docutils literal"><span class="pre">-</span></code> is minor (note also that we have to quote the
symbols as we pass them to <code class="docutils literal"><span class="pre">pc:diatonic</span></code>). Also, because Scheme
symbols are lowercase only we use <code class="docutils literal"><span class="pre">i</span></code> for <code class="docutils literal"><span class="pre">I</span></code> <code class="docutils literal"><span class="pre">v</span></code> for <code class="docutils literal"><span class="pre">V</span></code>, etc.
Because <code class="docutils literal"><span class="pre">pc:diatonic</span></code> is passed major or minor it is clever enough to
know that <code class="docutils literal"><span class="pre">i</span></code> means <code class="docutils literal"><span class="pre">I</span></code> and that <code class="docutils literal"><span class="pre">vii</span></code> means <code class="docutils literal"><span class="pre">viio</span></code> in the major
key. In minor <code class="docutils literal"><span class="pre">i</span></code> will be minor etc... Let&#8217;s look at an example that
implements our entire matrix.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; markov chord progression I ii iii IV V vi vii</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">progression</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">degree</span><span class="p">)</span>
    <span class="p">(</span><span class="k">for-each</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
                <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="nv">p</span> <span class="mi">80</span> <span class="mi">40000</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">pc:make-chord</span> <span class="mi">48</span> <span class="mi">77</span> <span class="mi">5</span> <span class="p">(</span><span class="nv">pc:diatonic</span> <span class="mi">0</span> <span class="ss">&#39;^</span> <span class="nv">degree</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">40000</span><span class="p">)</span> <span class="ss">&#39;progression</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mi">44100</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">assoc</span> <span class="nv">degree</span> <span class="o">&#39;</span><span class="p">((</span><span class="nv">i</span> <span class="nv">iv</span> <span class="nv">v</span> <span class="nv">iii</span> <span class="nv">vi</span><span class="p">)</span>
                                           <span class="p">(</span><span class="nv">ii</span> <span class="nv">v</span> <span class="nv">vii</span><span class="p">)</span>
                                           <span class="p">(</span><span class="nv">iii</span> <span class="nv">vi</span><span class="p">)</span>
                                           <span class="p">(</span><span class="nv">iv</span> <span class="nv">v</span> <span class="nv">ii</span> <span class="nv">vii</span> <span class="nv">i</span><span class="p">)</span>
                                           <span class="p">(</span><span class="nv">v</span> <span class="nv">i</span> <span class="nv">vi</span><span class="p">)</span>
                                           <span class="p">(</span><span class="nv">vii</span> <span class="nv">v</span> <span class="nv">i</span><span class="p">)</span>
                                           <span class="p">(</span><span class="nv">vi</span> <span class="nv">ii</span><span class="p">))))))))</span>

<span class="p">(</span><span class="nv">progression</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="ss">&#39;i</span><span class="p">)</span>
</pre></div>
</div>
<p>Now I&#8217;m getting tired of the <code class="docutils literal"><span class="pre">synth</span></code> we&#8217;ve been playing all
along&#8212;let&#8217;s try playing this on an organ instead. Let&#8217;s also make a
couple of performance changes:</p>
<ol class="arabic simple">
<li>we&#8217;ll randomly add mordants</li>
<li>we&#8217;ll make I and IV twice the duration of the other chords</li>
</ol>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; create our organ instrument (again, organ_note_c and organ_fx</span>
 <span class="c1">;; are defined in libs/core/instruments.xtm</span>
<span class="p">(</span><span class="nv">bind-instrument</span> <span class="nv">organ</span> <span class="nv">organ_note_c</span> <span class="nv">organ_fx</span><span class="p">)</span>

<span class="c1">;; add the instrument to the DSP output sink closure</span>
<span class="p">(</span><span class="k">bind-func</span> <span class="nf">dsp</span><span class="kt">:DSP</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nv">synth</span> <span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)</span>
       <span class="p">(</span><span class="k">or</span><span class="nv">gan</span> <span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">))))</span>

<span class="c1">;; mordant</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">play-note-mord</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">inst</span> <span class="nv">pitch</span> <span class="nv">vol</span> <span class="nv">duration</span> <span class="nv">pc</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">time</span> <span class="mi">5000</span><span class="p">)</span> <span class="nv">inst</span> <span class="nv">pitch</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">vol</span> <span class="mi">10</span><span class="p">)</span> <span class="mi">2500</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">time</span> <span class="mi">2500</span><span class="p">)</span> <span class="nv">inst</span> <span class="p">(</span><span class="nv">pc:relative</span> <span class="nv">pitch</span> <span class="mi">1</span> <span class="nv">pc</span><span class="p">)</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">vol</span> <span class="mi">10</span><span class="p">)</span> <span class="mi">2500</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">inst</span> <span class="nv">pitch</span> <span class="nv">vol</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">duration</span> <span class="mi">5000</span><span class="p">))))</span>

<span class="c1">;; markov chord progression I ii iii IV V vi vii</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">progression</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">degree</span><span class="p">)</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">dur</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">member</span> <span class="nv">degree</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">i</span> <span class="nv">iv</span><span class="p">))</span> <span class="mi">88200</span> <span class="mi">44100</span><span class="p">)))</span>
      <span class="p">(</span><span class="k">for-each</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
                  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="nv">p</span> <span class="mi">70</span><span class="p">)</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="p">(</span><span class="nf">random</span><span class="p">)</span> <span class="o">.</span><span class="mi">7</span><span class="p">))</span>
                      <span class="p">(</span><span class="nv">play-note-mord</span> <span class="nv">time</span> <span class="nv">synth</span> <span class="nv">p</span>
                                      <span class="p">(</span><span class="nf">random</span> <span class="mi">70</span> <span class="mi">80</span><span class="p">)</span>
                                      <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">9</span> <span class="nv">dur</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">))</span>
                      <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">organ</span> <span class="nv">p</span> <span class="p">(</span><span class="nf">random</span> <span class="mi">70</span> <span class="mi">80</span><span class="p">)</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">9</span> <span class="nv">dur</span><span class="p">))))</span>
                <span class="p">(</span><span class="nv">pc:make-chord</span> <span class="mi">40</span> <span class="mi">78</span> <span class="mi">4</span> <span class="p">(</span><span class="nv">pc:diatonic</span> <span class="mi">0</span> <span class="ss">&#39;^</span> <span class="nv">degree</span><span class="p">)))</span>
      <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">9</span> <span class="nv">dur</span><span class="p">))</span> <span class="ss">&#39;progression</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">dur</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">assoc</span> <span class="nv">degree</span> <span class="o">&#39;</span><span class="p">((</span><span class="nv">i</span> <span class="nv">iv</span> <span class="nv">v</span> <span class="nv">iii</span> <span class="nv">vi</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">ii</span> <span class="nv">v</span> <span class="nv">vii</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">iii</span> <span class="nv">vi</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">iv</span> <span class="nv">v</span> <span class="nv">ii</span> <span class="nv">vii</span> <span class="nv">i</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">v</span> <span class="nv">i</span> <span class="nv">vi</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">vii</span> <span class="nv">v</span> <span class="nv">i</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">vi</span> <span class="nv">ii</span><span class="p">)))))))))</span>

<span class="p">(</span><span class="nv">progression</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="ss">&#39;i</span><span class="p">)</span>
</pre></div>
</div>
<p>If you had any temporal recursion-based music (e.g. the <em>previous</em>
<code class="docutils literal"><span class="pre">progression</span></code> callback loop) playing when you evaluated the
<code class="docutils literal"><span class="pre">define-instrumnent</span></code> form, then you may have heard a pause in the
audio output while the xtlang code compiled. This is because the
compilation of <code class="docutils literal"><span class="pre">organ</span></code> was happening in the same Scheme process as the
<code class="docutils literal"><span class="pre">progression</span></code> callback loop. The Scheme process has to wait until the
compiler is done before it can continue with other Scheme code
execution.</p>
<p>The solution to this problem is to run the <code class="docutils literal"><span class="pre">progression</span></code> callback in a
separate process. There&#8217;s a blog guide in the works about how Extempore
handles multiple processes and concurrency, but for the moment if you&#8217;re
interested have a look at the stuff at the bottom of the
<code class="docutils literal"><span class="pre">examples/external/horde3d_knight.xtm</span></code> example file. The
<code class="docutils literal"><span class="pre">ipc:</span></code>-prefixed functions create and manage multiple processes in
Extempore. If you&#8217;re just mucking around at home, it&#8217;s probably not a
big problem to have a small pause in the audio output when you
re-compile things. But if it <em>is</em> a problem, take heart that there are
fairly straightforward ways to get around the problem.</p>
<p>Ok so, as a final exercise let&#8217;s try to make a simple <code class="docutils literal"><span class="pre">organ</span></code> ditty
for 5 parts, and we should try to have some simple part movement (i.e.
not just block chords everywhere). Now to do this, we&#8217;re going to cheat
and use <code class="docutils literal"><span class="pre">pc:relative</span></code> to move from our chord tones on <em>off
beats</em>&#8212;Schoenberg would be most displeased! We&#8217;ll also add an even
longer duration option for <code class="docutils literal"><span class="pre">I</span></code> and <code class="docutils literal"><span class="pre">IV</span></code>.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; Quintet</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">progression</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">degree</span><span class="p">)</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">dur</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">member</span> <span class="nv">degree</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">i</span> <span class="nv">iv</span><span class="p">))</span> <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">list</span> <span class="mi">88200</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">2</span> <span class="mi">88200</span><span class="p">)))</span> <span class="mi">44100</span><span class="p">)))</span>
      <span class="p">(</span><span class="k">for-each</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
                  <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="k">and</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="p">(</span><span class="nf">random</span><span class="p">)</span> <span class="o">.</span><span class="mi">7</span><span class="p">)</span> <span class="p">(</span><span class="nf">&lt;</span> <span class="nv">dur</span> <span class="mi">80000</span><span class="p">))</span>
                         <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">organ</span> <span class="nv">p</span> <span class="p">(</span><span class="nf">random</span> <span class="mi">60</span> <span class="mi">70</span><span class="p">)</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">3</span> <span class="nv">dur</span><span class="p">))</span>
                         <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">dur</span><span class="p">))</span>
                                    <span class="nv">organ</span>
                                    <span class="p">(</span><span class="nv">pc:relative</span> <span class="nv">p</span> <span class="p">(</span><span class="nf">random</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">-1</span> <span class="mi">1</span><span class="p">))</span>
                                                 <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span> <span class="mi">11</span><span class="p">))</span>
                                    <span class="p">(</span><span class="nf">random</span> <span class="mi">60</span> <span class="mi">80</span><span class="p">)</span>
                                    <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">3</span> <span class="nv">dur</span><span class="p">)))</span>
                        <span class="p">(</span><span class="k">else</span> <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span>
                                         <span class="nv">organ</span>
                                         <span class="nv">p</span>
                                         <span class="p">(</span><span class="nf">random</span> <span class="mi">60</span> <span class="mi">70</span><span class="p">)</span>
                                         <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">7</span> <span class="nv">dur</span><span class="p">)))))</span>
                <span class="p">(</span><span class="nv">pc:make-chord</span> <span class="mi">36</span> <span class="mi">90</span> <span class="mi">5</span> <span class="p">(</span><span class="nv">pc:diatonic</span> <span class="mi">0</span> <span class="ss">&#39;^</span> <span class="nv">degree</span><span class="p">)))</span>
      <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">8</span> <span class="nv">dur</span><span class="p">))</span> <span class="ss">&#39;progression</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">dur</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">assoc</span> <span class="nv">degree</span> <span class="o">&#39;</span><span class="p">((</span><span class="nv">i</span> <span class="nv">iv</span> <span class="nv">v</span> <span class="nv">iii</span> <span class="nv">vi</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">ii</span> <span class="nv">v</span> <span class="nv">vii</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">iii</span> <span class="nv">vi</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">iv</span> <span class="nv">v</span> <span class="nv">ii</span> <span class="nv">vii</span> <span class="nv">i</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">v</span> <span class="nv">i</span> <span class="nv">vi</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">vii</span> <span class="nv">v</span> <span class="nv">i</span><span class="p">)</span>
                                             <span class="p">(</span><span class="nv">vi</span> <span class="nv">ii</span><span class="p">)))))))))</span>

<span class="p">(</span><span class="nv">progression</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="ss">&#39;i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="beat-tempo">
<h2>Beat &amp; tempo<a class="headerlink" href="#beat-tempo" title="Permalink to this headline">¶</a></h2>
<p>&#8216;Bring back the beat&#8217; I hear you say. OK, on to beat &amp; tempo. In this
section we&#8217;re going to need a drum instrument. What a
coincidence&#8212;there&#8217;s <a class="reference internal" href="making-an-instrument.html"><span class="doc">another guide</span></a>
which shows you how to do exactly that! It&#8217;ll take a bit of time to
set up the first time, and you may have to download some samples (all
free and legal, of course). But don&#8217;t worry, I&#8217;ll wait here till you
get back.</p>
<p>Got a drum sampler set up? Great. So far we have been using
Extempore&#8217;s default time standard&#8212;samples per second&#8212;to control
rhythm and duration information. As musicians though, we are more used
to working with beats and tempo. Here&#8217;s a simple example working with
samples. Note that throughout this tutorial I&#8217;m using a drum sampler,
see <a class="reference internal" href="sampler.html"><span class="doc">Loading and using a sampler</span></a> for details on how to set that up. At the end of this
page you&#8217;ll find a list of general MIDI drum numbers which I&#8217;ll be
using in this tutorial: <code class="docutils literal"><span class="pre">*gm-cowbell*</span></code>, etc...</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; assuming you&#39;ve set up and loaded the drums sampler</span>
<span class="p">(</span><span class="k">bind-func</span> <span class="nf">dsp</span><span class="kt">:DSP</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nv">synth</span> <span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)</span>
       <span class="p">(</span><span class="k">or</span><span class="nv">gan</span> <span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">drums</span> <span class="nv">in</span> <span class="nv">time</span> <span class="nv">chan</span> <span class="nv">dat</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">drum-loop</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">dur</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">drums</span> <span class="nv">*gm-cowbell*</span> <span class="mi">80</span> <span class="nv">dur</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">dur</span><span class="p">))</span> <span class="ss">&#39;drum-loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">dur</span><span class="p">)</span> <span class="p">(</span><span class="nf">random</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">22050</span> <span class="mi">11025</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">drum-loop</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="mi">11025</span><span class="p">)</span>
</pre></div>
</div>
<p>And here&#8217;s one way that we could go about transforming this into a more
abstract notion of time.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; beat loop</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">drum-loop</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">dur</span><span class="p">)</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">d</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">dur</span> <span class="nv">*samplerate*</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">drums</span> <span class="nv">*gm-cowbell*</span> <span class="mi">80</span> <span class="nv">d</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">d</span><span class="p">))</span> <span class="ss">&#39;drum-loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">d</span><span class="p">)</span> <span class="p">(</span><span class="nf">random</span> <span class="o">&#39;</span><span class="p">(</span><span class="mf">0.5</span> <span class="mf">0.25</span><span class="p">))))))</span>

<span class="p">(</span><span class="nv">drum-loop</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
<p>So what&#8217;s the advantage here&#8212;is it more work for no benefit? Well, there
are actually two big advantages:</p>
<ol class="arabic simple">
<li>Ratio&#8217;s are easier to deal with than samples: <code class="docutils literal"><span class="pre">0.25</span></code> is easier to
remember than <code class="docutils literal"><span class="pre">11025</span></code> (assuming a samplerate of <code class="docutils literal"><span class="pre">44100</span></code>)</li>
<li>this system supports alternate tempos, so we can change tempo without
having to change any rhythm values.</li>
</ol>
<p>Let&#8217;s play back the same example at 120 beats per minute
(bpm)&#8212;remembering that by default the Extempore metronome runs at 60
bpm. We&#8217;ll also add triplets to our quavers and semi-quavers.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; beat loop at 120bpm</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">drum-loop</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">dur</span><span class="p">)</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">d</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">dur</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">*samplerate*</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">drums</span> <span class="nv">*gm-cowbell*</span> <span class="mi">80</span> <span class="nv">d</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">d</span><span class="p">))</span> <span class="ss">&#39;drum-loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">d</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">list</span> <span class="p">(</span><span class="nf">/</span> <span class="mi">1</span> <span class="mi">3</span><span class="p">)</span> <span class="mf">0.5</span> <span class="mf">0.25</span><span class="p">))))))</span>

<span class="p">(</span><span class="nv">drum-loop</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
<p>Let&#8217;s try using an oscillator to drift the playback speed back and forth
over time.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; beat loop with tempo shift</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">drum-loop</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">dur</span><span class="p">)</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">d</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">dur</span> <span class="p">(</span><span class="nf">+</span> <span class="o">.</span><span class="mi">5</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">25</span> <span class="p">(</span><span class="nf">cos</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">16</span> <span class="mf">3.141592</span> <span class="nv">time</span><span class="p">))))</span> <span class="nv">*samplerate*</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">play-note</span> <span class="nv">time</span> <span class="nv">drums</span> <span class="nv">*gm-cowbell*</span> <span class="mi">80</span> <span class="nv">d</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">d</span><span class="p">))</span> <span class="ss">&#39;drum-loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">d</span><span class="p">)</span>
                <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">list</span> <span class="mf">0.5</span><span class="p">))))))</span>

<span class="p">(</span><span class="nv">drum-loop</span> <span class="p">(</span><span class="nf">now</span><span class="p">)</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p>All values are now 0.5 so we should get a nice even rhythm with a tempo
change over time. But if you&#8217;re evaluating and listening to the results
of <code class="docutils literal"><span class="pre">drum-loop</span></code>, it&#8217;s obvious that it <em>doesn&#8217;t</em> sound very even! It
turns out that tempo is a lot more subtle than you might expect. What we
actually need is a linear function that can more evenly distribute our
beats with respect to tempo changes.</p>
<p>As it turns out, <code class="docutils literal"><span class="pre">runtime/scheme.xtm</span></code> (which is loaded by default on
startup) includes a function called <code class="docutils literal"><span class="pre">make-metro</span></code> which will solve a
few of these problems. At it&#8217;s simplest, <code class="docutils literal"><span class="pre">make-metro</span></code> is a function
that accepts a tempo and returns a closure. We can then call that
closure with a (cumulative) time in beats and have an absolute sample
number returned to us. So the metronome provides a mapping from beats
(which are nice to work with) to samples (which Extempore needs to work
with). This makes more sense as a practical exercise, so let me
demonstrate.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; create a metronome starting at 120 bpm</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metro*</span> <span class="p">(</span><span class="nv">make-metro</span> <span class="mi">120</span><span class="p">))</span>

<span class="c1">;; beat loop</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">drum-loop</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">duration</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">println</span> <span class="nv">time</span> <span class="nv">duration</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-cowbell*</span> <span class="mi">80</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;dur</span> <span class="nv">duration</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">duration</span><span class="p">)))</span> <span class="ss">&#39;drum-loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">duration</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">list</span> <span class="mf">0.5</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">drum-loop</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span><span class="p">)</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p>You should notice a couple of things:</p>
<ol class="arabic simple">
<li>We start our loop by calling <code class="docutils literal"><span class="pre">(*metro*</span> <span class="pre">'get-beat)</span></code>. This asks our
<code class="docutils literal"><span class="pre">*metro*</span></code> closure to return the next available beat number to us,
i.e. <code class="docutils literal"><span class="pre">(fmod</span> <span class="pre">beat</span> <span class="pre">1.0)</span></code>. <code class="docutils literal"><span class="pre">*metro*</span></code> starts ticking over beats as
soon as it&#8217;s initialized</li>
<li><code class="docutils literal"><span class="pre">time</span></code> is now in beats (not in samples) and is cumulative. Check
your logview for an idea about what the value of <code class="docutils literal"><span class="pre">time</span></code> is each
time through the drum-loop. Also remember that floating point is
subject to rounding error&#8212;but don&#8217;t lose too much sleep over that for
the moment</li>
<li><code class="docutils literal"><span class="pre">(*metro*</span> <span class="pre">'dur</span> <span class="pre">duration)</span></code> returns a duration in samples relative to
the current tempo</li>
<li>The closure returned by <code class="docutils literal"><span class="pre">(make-metro)</span></code> is really a kind of object
and the symbol names are method names&#8212;message names really. Any
arguments after the message name are passed with the message and
dispatched inside the closure to the appropriate &#8216;method&#8217;. What we
are using here is a form of message passing. Who said Scheme wasn&#8217;t
an OO language!</li>
</ol>
<p>How about those tempo changes? No problem&#8212;we just need to use pass
another message to <code class="docutils literal"><span class="pre">*metro*</span></code> closure: <code class="docutils literal"><span class="pre">set-tempo</span></code>, which sets a new
tempo in bpm (and don&#8217;t forget to quote the symbol).</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; create a metronome starting at 120 bpm</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metro*</span> <span class="p">(</span><span class="nv">make-metro</span> <span class="mi">120</span><span class="p">))</span>

<span class="c1">;; beat loop with tempo shift</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">drum-loop</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">duration</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;set-tempo</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">120</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">40</span> <span class="p">(</span><span class="nf">cos</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">25</span> <span class="mf">3.141592</span> <span class="nv">time</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-cowbell*</span> <span class="mi">80</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;dur</span> <span class="nv">duration</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">duration</span><span class="p">)))</span> <span class="ss">&#39;drum-loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">duration</span><span class="p">)</span>
              <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">list</span> <span class="mf">0.5</span><span class="p">)))))</span>

<span class="p">(</span><span class="nv">drum-loop</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span><span class="p">)</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
<p>More cowbell! Much better, I&#8217;m sure you will agree. Now the really cool
thing about <code class="docutils literal"><span class="pre">*metro*</span></code> is that you can now use it to sync as many
<code class="docutils literal"><span class="pre">callback</span></code> loops as you like. Let&#8217;s add a second <code class="docutils literal"><span class="pre">drum-loop</span></code> call.
Notice also that we have added an argument to the <code class="docutils literal"><span class="pre">get-beat</span></code> message
that asks the metronome to return a beat number which is equal to <code class="docutils literal"><span class="pre">0</span></code>
mod <code class="docutils literal"><span class="pre">4</span></code>. I&#8217;m going to play cowbell and triangle with a slight <code class="docutils literal"><span class="pre">0.25</span></code>
offset.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; create a metronome starting at 120 bpm</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metro*</span> <span class="p">(</span><span class="nv">make-metro</span> <span class="mi">120</span><span class="p">))</span>

<span class="c1">;; beat loop with tempo shift</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">drum-loop</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">duration</span> <span class="nv">pitch</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">pitch</span> <span class="mi">80</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;dur</span> <span class="nv">duration</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">5</span> <span class="nv">duration</span><span class="p">)))</span> <span class="ss">&#39;drum-loop</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="nv">duration</span><span class="p">)</span>
              <span class="nv">duration</span>
              <span class="nv">pitch</span><span class="p">)))</span>

<span class="c1">;; shift tempo over time using oscillator</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">tempo-shift</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;set-tempo</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">120</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">40</span> <span class="p">(</span><span class="nf">cos</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">25</span> <span class="mf">3.141592</span> <span class="nv">time</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="o">.</span><span class="mi">2</span><span class="p">))</span> <span class="ss">&#39;tempo-shift</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="o">.</span><span class="mi">25</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">drum-loop</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span> <span class="mi">4</span><span class="p">)</span> <span class="mf">0.5</span> <span class="nv">*gm-cowbell*</span><span class="p">)</span>
<span class="p">(</span><span class="nv">drum-loop</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span> <span class="mf">4.25</span><span class="p">)</span> <span class="mf">0.5</span> <span class="nv">*gm-open-triangle*</span><span class="p">)</span>
<span class="p">(</span><span class="nv">tempo-shift</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span> <span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<p>Ahhh, like clockwork. Notice that now we are running two independent
<code class="docutils literal"><span class="pre">drum-loop</span></code> temporal callbacks we need to put the tempo shift in a
separate function&#8212;we don&#8217;t want the tempo to be set independently by two
seperate loops!</p>
<p>We now have almost enough information to build our first drum machine!</p>
<p>Extempore also has a very useful function called <code class="docutils literal"><span class="pre">make-metre</span></code>. Like
the <code class="docutils literal"><span class="pre">make-metro</span></code> function, the <code class="docutils literal"><span class="pre">make-metre</span></code> function returns a
closure which can subsequently be called. <code class="docutils literal"><span class="pre">make-metre</span></code> returns a
closure that returns <code class="docutils literal"><span class="pre">#t</span></code> or <code class="docutils literal"><span class="pre">#f</span></code> based on a simple query: given an
accumulated beat, are we on a certain metric pulse? A practical demo
should make this a little clearer.</p>
<p>First though, a brief explanation of <code class="docutils literal"><span class="pre">make-metre</span></code> initial arguments.
The first argument is <em>a list of</em> numerators and the second argument is
a <em>single</em> denominator. What this implies is that <code class="docutils literal"><span class="pre">make-metre</span></code> can
work with a series of revolving metres. Some examples:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">(make-metre</span> <span class="pre">'(4)</span> <span class="pre">1.0)</span></code> gives us <code class="docutils literal"><span class="pre">4</span></code> times <code class="docutils literal"><span class="pre">1.0</span></code> metric pulses
(recurring every <code class="docutils literal"><span class="pre">4/4</span></code> bars);</li>
<li><code class="docutils literal"><span class="pre">(make-metre</span> <span class="pre">'(3)</span> <span class="pre">0.5)</span></code> gives us <code class="docutils literal"><span class="pre">3</span></code> times <code class="docutils literal"><span class="pre">0.5</span></code> metric pulses
(recurring every <code class="docutils literal"><span class="pre">3/8</span></code> bars)</li>
<li><code class="docutils literal"><span class="pre">(make-metre</span> <span class="pre">'(2</span> <span class="pre">3)</span> <span class="pre">0.5)</span></code> gives us <code class="docutils literal"><span class="pre">2</span></code> times <code class="docutils literal"><span class="pre">0.5</span></code> then <code class="docutils literal"><span class="pre">3</span></code>
times <code class="docutils literal"><span class="pre">0.5</span></code> metric pulses (a recurring series of <code class="docutils literal"><span class="pre">2/8</span></code> <code class="docutils literal"><span class="pre">3/8</span></code>
<code class="docutils literal"><span class="pre">2/8</span></code> <code class="docutils literal"><span class="pre">3/8</span></code> <code class="docutils literal"><span class="pre">2/8</span></code> <code class="docutils literal"><span class="pre">3/8</span></code>...).</li>
</ul>
<p>Let&#8217;s try using a <code class="docutils literal"><span class="pre">make-metre</span></code>. We&#8217;ll only play the first beat of each
bar.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="k">define</span> <span class="nv">*metro*</span> <span class="p">(</span><span class="nv">make-metro</span> <span class="mi">90</span><span class="p">))</span>

<span class="c1">;; a 2/8 3/8 2/8 cycle</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metre*</span> <span class="p">(</span><span class="nv">make-metre</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">2</span><span class="p">)</span> <span class="mf">0.5</span><span class="p">))</span>

<span class="c1">;; play first beat of each &#39;bar&#39;</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">metre-test</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metre*</span> <span class="nv">time</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-side-stick*</span> <span class="mi">80</span> <span class="mi">10000</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mf">0.4</span><span class="p">))</span> <span class="ss">&#39;metre-test</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mf">0.5</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">metre-test</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span> <span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<p>Well, that was easy. Let&#8217;s complicate things just a little by adding a
second metre. We&#8217;ll play the side stick for the first metre and the
snare for the second metre.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; classic 2 against 3</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metro*</span> <span class="p">(</span><span class="nv">make-metro</span> <span class="mi">180</span><span class="p">))</span>

<span class="c1">;; 3/8</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metre1*</span> <span class="p">(</span><span class="nv">make-metre</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span>
<span class="c1">;; 2/8</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metre2*</span> <span class="p">(</span><span class="nv">make-metre</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span>


<span class="c1">;; play first beat of each &#39;bar&#39;</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">metre-test</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metre1*</span> <span class="nv">time</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-side-stick*</span> <span class="mi">80</span> <span class="mi">10000</span><span class="p">))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metre2*</span> <span class="nv">time</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-snare*</span> <span class="mi">60</span> <span class="mi">10000</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mf">0.4</span><span class="p">))</span> <span class="ss">&#39;metre-test</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mf">0.5</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">metre-test</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span> <span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<p>The French composer Olivier Messiaen is well known for (amongst other
things) symmetrical metric structures. Let&#8217;s follow his lead and build
up a relatively complex poly-symmetric drum pattern. Again, we&#8217;re going
to work with two competing metric structures&#8212;both of which will be
symmetric <code class="docutils literal"><span class="pre">(2/8</span> <span class="pre">3/8</span> <span class="pre">4/8</span> <span class="pre">3/8</span> <span class="pre">2/8)</span></code> and <code class="docutils literal"><span class="pre">(3/8</span> <span class="pre">5/8</span> <span class="pre">7/8</span> <span class="pre">5/8</span> <span class="pre">3/8)</span></code>.
Because the second metric structure is uneven in length we should get
some nice phasing effects, <em>a la</em> Steve Reich. I&#8217;m also going to add
some hi-hats to give it a constant pulse.</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="c1">;; messiaen drum kit</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metro*</span> <span class="p">(</span><span class="nv">make-metro</span> <span class="mi">140</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">*metre1*</span> <span class="p">(</span><span class="nv">make-metre</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">3</span> <span class="mi">2</span><span class="p">)</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metre2*</span> <span class="p">(</span><span class="nv">make-metre</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">5</span> <span class="mi">3</span><span class="p">)</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span>

<span class="c1">;; play first beat of each &#39;bar&#39;</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">metre-test</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span>
               <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cons</span> <span class="o">.</span><span class="mi">8</span> <span class="nv">*gm-closed-hi-hat*</span><span class="p">)</span> <span class="p">(</span><span class="nf">cons</span> <span class="o">.</span><span class="mi">2</span> <span class="nv">*gm-open-hi-hat*</span><span class="p">))</span>
               <span class="p">(</span><span class="nf">+</span> <span class="mi">40</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">20</span> <span class="p">(</span><span class="nf">cos</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">2</span> <span class="mf">3.441592</span> <span class="nv">time</span><span class="p">))))</span>
               <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cons</span> <span class="o">.</span><span class="mi">8</span> <span class="mi">500</span><span class="p">)</span>  <span class="p">(</span><span class="nf">cons</span> <span class="o">.</span><span class="mi">2</span> <span class="mi">2000</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metre1*</span> <span class="nv">time</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">(</span><span class="k">begin</span> <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-snare*</span> <span class="mi">80</span> <span class="mi">10000</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-pedal-hi-hat*</span> <span class="mi">80</span> <span class="mi">100000</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metre2*</span> <span class="nv">time</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">(</span><span class="k">begin</span> <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-kick*</span> <span class="mi">80</span> <span class="mi">100000</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-ride-bell*</span> <span class="mi">100</span> <span class="mi">100000</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mf">0.2</span><span class="p">))</span> <span class="ss">&#39;metre-test</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mf">0.25</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">metre-test</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span> <span class="mf">1.0</span><span class="p">))</span>
</pre></div>
</div>
<p>There are a couple of things to note in the previous example. Firstly,
our old oscillating volume is back in the hi-hat parts. We are also
using a weighted <code class="docutils literal"><span class="pre">random</span></code> for both the choice of hi-hat pitch and the
length of the hi-hat sound. Also notice that we are moving around our
callback faster than before&#8212;but this is fine as long as our time
increment has a suitable ratio to both metres.</p>
</div>
<div class="section" id="putting-it-all-together">
<h2>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s keep going with this idea and add some pitched musical content as
well, using the <code class="docutils literal"><span class="pre">synth</span></code> and <code class="docutils literal"><span class="pre">organ</span></code> instruments we were using
earlier</p>
<div class="highlight-extempore"><div class="highlight"><pre><span class="p">(</span><span class="nv">sys:load</span> <span class="s">&quot;libs/core/pc_ivl.xtm&quot;</span><span class="p">)</span>

<span class="c1">;; messiaen drum kit</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metro*</span> <span class="p">(</span><span class="nv">make-metro</span> <span class="mi">140</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">*metre1*</span> <span class="p">(</span><span class="nv">make-metre</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">3</span> <span class="mi">2</span><span class="p">)</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">*metre2*</span> <span class="p">(</span><span class="nv">make-metre</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">5</span> <span class="mi">3</span><span class="p">)</span> <span class="o">.</span><span class="mi">5</span><span class="p">))</span>

<span class="c1">;; play first beat of each &#39;bar&#39;</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">metre-test</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">time</span> <span class="nv">degree</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span>
               <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cons</span> <span class="o">.</span><span class="mi">8</span> <span class="nv">*gm-closed-hi-hat*</span><span class="p">)</span> <span class="p">(</span><span class="nf">cons</span> <span class="o">.</span><span class="mi">2</span> <span class="nv">*gm-open-hi-hat*</span><span class="p">))</span>
               <span class="p">(</span><span class="nf">+</span> <span class="mi">40</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">20</span> <span class="p">(</span><span class="nf">cos</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">2</span> <span class="mf">3.141592</span> <span class="nv">time</span><span class="p">))))</span>
               <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cons</span> <span class="o">.</span><span class="mi">8</span> <span class="mi">500</span><span class="p">)</span>  <span class="p">(</span><span class="nf">cons</span> <span class="mi">2</span> <span class="mi">2000</span><span class="p">))</span>
               <span class="mi">9</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">synth</span>
               <span class="p">(</span><span class="nv">pc:random</span> <span class="mi">90</span> <span class="mi">107</span> <span class="p">(</span><span class="nv">pc:diatonic</span> <span class="mi">9</span> <span class="ss">&#39;-</span> <span class="nv">degree</span><span class="p">))</span>
               <span class="p">(</span><span class="nf">+</span> <span class="mi">50</span> <span class="p">(</span><span class="nf">*</span> <span class="mi">25</span> <span class="p">(</span><span class="nf">cos</span> <span class="p">(</span><span class="nf">*</span> <span class="o">.</span><span class="mi">125</span> <span class="mf">3.141592</span> <span class="nv">time</span><span class="p">))))</span>
               <span class="mi">100</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metre1*</span> <span class="nv">time</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">(</span><span class="k">begin</span> <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-snare*</span> <span class="mi">80</span> <span class="mi">10000</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-pedal-hi-hat*</span> <span class="mi">80</span> <span class="mi">100000</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">organ</span>
                          <span class="p">(</span><span class="nf">+</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">car</span> <span class="p">(</span><span class="nv">pc:diatonic</span> <span class="mi">9</span> <span class="ss">&#39;-</span> <span class="nv">degree</span><span class="p">)))</span>
                          <span class="mi">60</span>
                          <span class="mi">10000</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metre2*</span> <span class="nv">time</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">(</span><span class="k">begin</span> <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-kick*</span> <span class="mi">100</span> <span class="mi">100000</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">drums</span> <span class="nv">*gm-ride-bell*</span> <span class="mi">100</span> <span class="mi">100000</span><span class="p">)</span>
               <span class="p">(</span><span class="k">for-each</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">p</span><span class="p">)</span>
                           <span class="p">(</span><span class="nv">play-note</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="nv">time</span><span class="p">)</span> <span class="nv">synth</span> <span class="nv">p</span> <span class="mi">70</span> <span class="mi">10000</span><span class="p">))</span>
                         <span class="p">(</span><span class="nv">pc:make-chord</span> <span class="mi">65</span> <span class="mi">80</span> <span class="mi">3</span> <span class="p">(</span><span class="nv">pc:diatonic</span> <span class="mi">9</span> <span class="ss">&#39;-</span> <span class="nv">degree</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nf">callback</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mf">0.2</span><span class="p">))</span> <span class="ss">&#39;metre-test</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">time</span> <span class="mf">0.25</span><span class="p">)</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">=</span> <span class="mf">0.0</span> <span class="p">(</span><span class="nf">modulo</span> <span class="nv">time</span> <span class="mf">8.0</span><span class="p">))</span>
                  <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">cdr</span> <span class="p">(</span><span class="nf">assoc</span> <span class="nv">degree</span> <span class="o">&#39;</span><span class="p">((</span><span class="nv">i</span> <span class="nv">vii</span> <span class="nv">vii</span> <span class="nv">vi</span><span class="p">)</span>
                                               <span class="p">(</span><span class="nv">n</span> <span class="nv">v</span><span class="p">)</span>
                                               <span class="p">(</span><span class="nv">vi</span> <span class="nv">n</span><span class="p">)</span>
                                               <span class="p">(</span><span class="nv">v</span> <span class="nv">vi</span> <span class="nv">i</span><span class="p">)</span>
                                               <span class="p">(</span><span class="nv">vii</span> <span class="nv">i</span><span class="p">)))))</span>
                  <span class="nv">degree</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">metre-test</span> <span class="p">(</span><span class="nf">*</span><span class="nv">metro*</span> <span class="ss">&#39;get-beat</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ss">&#39;i</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example we have used many of the techniques picked up in
previous tutorials, so take some time and have a good look through this
code. If you can understand it, then you&#8217;re well on your way to making
music in Extempore. It&#8217;s also a good starting point for changing things
yourself&#8212;there are plenty of interesting parameters &amp; code chunks to
tweak. Get in there and try it, and don&#8217;t be afraid to break things :)</p>
<p>And remember, the note-level control that we&#8217;ve looked at in this
tutorial is just <em>one</em> way to use Extempore. You can also do DSP,
graphics, distributed computing, network IO, high-performance
number-crunching, and many other things.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="common-lisp-music.html" class="btn btn-neutral float-right" title="“Common Lisp Music”-style example" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="making-an-instrument.html" class="btn btn-neutral" title="Making an instrument" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Andrew Sorensen.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.7.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>